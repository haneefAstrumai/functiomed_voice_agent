services:

  # ── 1. LiveKit Server ──────────────────────────────────────
  livekit:
    image: livekit/livekit-server:latest
    container_name: functiomed_livekit
    ports:
      - "7880:7880"
      - "7881:7881"
      - "7882:7882/udp"
    command: --dev --bind 0.0.0.0
    restart: unless-stopped

  # ── 2. FastAPI Backend ────────────────────────────────────
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: functiomed_backend
    ports:
      - "8000:8000"
    environment:
      - GROQ_API_KEY=${GROQ_API_KEY}
      - LIVEKIT_URL=ws://livekit:7880
      - LIVEKIT_URL_BROWSER=ws://localhost:7880
      - LIVEKIT_API_KEY=${LIVEKIT_API_KEY:-devkey}
      - LIVEKIT_API_SECRET=${LIVEKIT_API_SECRET:-secret}
      - RERANKER_ENABLED=${RERANKER_ENABLED:-0}
      - PYTHONPATH=/app
    volumes:
      - ./data:/app/data
      - ./database:/app/database
      - ./pdf_data/files:/app/pdf_data/files
    depends_on:
      - livekit
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/ || exit 1"]
      interval: 20s
      timeout: 10s
      retries: 10
      start_period: 180s    # ← 3 minutes — first run downloads HuggingFace model

  # ── 3. Python Voice Agent ─────────────────────────────────
  agent:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: functiomed_agent
    environment:
      - GROQ_API_KEY=${GROQ_API_KEY}
      - LIVEKIT_URL=ws://livekit:7880
      - LIVEKIT_API_KEY=${LIVEKIT_API_KEY:-devkey}
      - LIVEKIT_API_SECRET=${LIVEKIT_API_SECRET:-secret}
      - RERANKER_ENABLED=${RERANKER_ENABLED:-0}
      - PYTHONPATH=/app
    volumes:
      - ./data:/app/data
      - ./database:/app/database
    depends_on:
      backend:
        condition: service_healthy
      livekit:
        condition: service_started
    command: python voice_agent/agent.py dev
    restart: unless-stopped

  # ── 4. React Frontend ─────────────────────────────────────
  frontend:
    build:
      context: ./frontend                  # Docker enters frontend/
      dockerfile: ../Dockerfile.frontend   # Dockerfile is at project root
    container_name: functiomed_frontend
    ports:
      - "5173:5173"
    environment:
      - VITE_BACKEND_URL=http://backend:8000
    depends_on:
      - backend
    restart: unless-stopped